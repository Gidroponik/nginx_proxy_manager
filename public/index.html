<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0a0a0a',
                            card: '#141414',
                            border: '#262626',
                            hover: '#1a1a1a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #141414; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body class="bg-dark-bg min-h-screen text-white">
    <!-- Header -->
    <header class="border-b border-dark-border sticky top-0 bg-dark-bg/95 backdrop-blur-sm z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center">
                        <i class="ri-server-line text-xl text-black"></i>
                    </div>
                    <h1 class="font-bold text-lg">Nginx Manager</h1>
                    <span id="osInfo" class="hidden sm:inline-flex px-3 py-1 bg-white text-black text-xs font-medium rounded-full">Загрузка...</span>
                    <div id="ipAddresses" class="hidden sm:flex items-center gap-2"></div>
                </div>
                <button onclick="logout()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors" title="Выход">
                    <i class="ri-logout-box-r-line text-xl text-gray-400 hover:text-white"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Actions -->
        <div class="flex flex-wrap gap-3 mb-6">
            <button onclick="showAddModal()" class="px-4 py-2.5 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition-colors flex items-center gap-2">
                <i class="ri-add-line"></i>
                <span class="hidden sm:inline">Добавить сайт</span>
            </button>
            <button onclick="loadConfigs()" class="px-4 py-2.5 bg-dark-card border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors flex items-center gap-2">
                <i class="ri-refresh-line"></i>
                <span class="hidden sm:inline">Обновить</span>
            </button>
            <button id="protectionBtn" onclick="setupDefault()" class="px-4 py-2.5 bg-dark-card border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-dark-card">
                <i class="ri-shield-line" id="protectionIcon"></i>
                <span class="hidden sm:inline" id="protectionText">Защита</span>
            </button>
            <button onclick="showLoadModal()" class="px-4 py-2.5 bg-dark-card border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors flex items-center gap-2">
                <i class="ri-dashboard-3-line"></i>
                <span class="hidden sm:inline">Нагрузка</span>
            </button>
            <button onclick="showApiKeysModal()" class="px-4 py-2.5 bg-dark-card border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors flex items-center gap-2">
                <i class="ri-key-2-line"></i>
                <span class="hidden sm:inline">API</span>
            </button>
            <button onclick="openDocs()" class="px-4 py-2.5 bg-dark-card border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors flex items-center gap-2">
                <i class="ri-book-open-line"></i>
                <span class="hidden sm:inline">Документация</span>
            </button>
        </div>

        <!-- Sites Grid -->
        <div class="grid gap-4 mb-6">
            <div class="bg-dark-card border border-dark-border rounded-2xl overflow-hidden">
                <div class="px-6 py-4 border-b border-dark-border">
                    <h2 class="font-semibold flex items-center gap-2">
                        <i class="ri-global-line text-gray-400"></i>
                        Сайты
                    </h2>
                </div>
                <div id="sitesContainer" class="divide-y divide-dark-border">
                    <div class="px-6 py-8 text-center text-gray-500">
                        <i class="ri-loader-4-line animate-spin text-2xl"></i>
                        <p class="mt-2">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="bg-dark-card border border-dark-border rounded-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between">
                <h2 class="font-semibold flex items-center gap-2">
                    <i class="ri-terminal-line text-gray-400"></i>
                    Логи
                </h2>
                <button onclick="loadLogs()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors">
                    <i class="ri-refresh-line text-gray-400"></i>
                </button>
            </div>
            <div class="p-4">
                <pre id="logsContainer" class="bg-dark-bg rounded-xl p-4 text-xs text-gray-400 font-mono h-64 overflow-auto scrollbar-thin"></pre>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="siteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-dark-card border border-dark-border rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between sticky top-0 bg-dark-card">
                <h3 id="modalTitle" class="font-semibold text-lg">Добавить сайт</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="siteForm" class="p-6 space-y-5">
                <input type="hidden" id="editFilename" name="filename">

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Домен</label>
                    <input type="text" name="domain" id="domainInput" required
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors"
                        placeholder="example.com">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Адрес проксирования</label>
                    <input type="text" name="proxyPass" id="proxyPassInput" required
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors"
                        placeholder="http://192.168.1.100:3000">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">WebSocket путь <span class="text-gray-600">(опционально)</span></label>
                    <input type="text" name="websocketPath" id="websocketInput"
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors"
                        placeholder="/api/ws">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Привязать к IP <span class="text-gray-600">(опционально)</span></label>
                    <select name="listenIP" id="listenIPSelect"
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white focus:outline-none focus:border-white transition-colors">
                        <option value="">Все интерфейсы (0.0.0.0)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">SSL сертификат</label>
                    <select name="sslType" id="sslTypeSelect" onchange="toggleSSLFields()"
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white focus:outline-none focus:border-white transition-colors">
                        <option value="letsencrypt">Let's Encrypt (авто)</option>
                        <option value="selfsigned">Самоподписанный (DDoS-Guard)</option>
                        <option value="custom">Свой сертификат</option>
                    </select>
                </div>

                <div id="customSSLFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Сертификат (fullchain.pem)</label>
                        <textarea name="sslCert" id="sslCertInput" rows="4"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors font-mono text-xs"
                            placeholder="-----BEGIN CERTIFICATE-----"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Приватный ключ (privkey.pem)</label>
                        <textarea name="sslKey" id="sslKeyInput" rows="4"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors font-mono text-xs"
                            placeholder="-----BEGIN PRIVATE KEY-----"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 py-3 bg-dark-bg border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors">
                        Отмена
                    </button>
                    <button type="submit" id="submitBtn"
                        class="flex-1 py-3 bg-white text-black font-semibold rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                        <i class="ri-check-line"></i>
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reissue Modal -->
    <div id="reissueModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-dark-card border border-dark-border rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between">
                <h3 class="font-semibold text-lg">Перевыпуск сертификата</h3>
                <button onclick="closeReissueModal()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <form id="reissueForm" class="p-6 space-y-5">
                <input type="hidden" id="reissueFilename">

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Тип сертификата</label>
                    <select id="reissueSslType" onchange="toggleReissueSSLFields()"
                        class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white focus:outline-none focus:border-white transition-colors">
                        <option value="letsencrypt">Let's Encrypt (авто)</option>
                        <option value="selfsigned">Самоподписанный (DDoS-Guard)</option>
                        <option value="custom">Свой сертификат</option>
                    </select>
                </div>

                <div id="reissueCustomSSLFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Сертификат</label>
                        <textarea id="reissueSslCert" rows="4"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors font-mono text-xs"
                            placeholder="-----BEGIN CERTIFICATE-----"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Приватный ключ</label>
                        <textarea id="reissueSslKey" rows="4"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors font-mono text-xs"
                            placeholder="-----BEGIN PRIVATE KEY-----"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeReissueModal()"
                        class="flex-1 py-3 bg-dark-bg border border-dark-border text-white font-medium rounded-xl hover:bg-dark-hover transition-colors">
                        Отмена
                    </button>
                    <button type="submit"
                        class="flex-1 py-3 bg-white text-black font-semibold rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                        <i class="ri-refresh-line"></i>
                        Перевыпустить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- System Load Modal -->
    <div id="loadModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-dark-card border border-dark-border rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between sticky top-0 bg-dark-card">
                <h3 class="font-semibold text-lg flex items-center gap-2">
                    <i class="ri-dashboard-3-line text-blue-400"></i>
                    Системная нагрузка
                    <span id="loadUptime" class="text-xs text-gray-500 font-normal ml-2"></span>
                </h3>
                <button onclick="closeLoadModal()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- CPU -->
                <div class="bg-dark-bg rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i class="ri-cpu-line text-blue-400"></i>
                            <span class="font-medium">Процессор</span>
                        </div>
                        <span id="loadCpuPercent" class="text-xl font-bold">--%</span>
                    </div>
                    <div class="text-sm text-gray-400 mb-2" id="loadCpuModel">Загрузка...</div>
                    <div class="h-2 bg-dark-card rounded-full overflow-hidden">
                        <div id="loadCpuBar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2" id="loadCpuInfo"></div>
                </div>

                <!-- Memory -->
                <div class="bg-dark-bg rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i class="ri-ram-line text-green-400"></i>
                            <span class="font-medium">Память</span>
                        </div>
                        <span id="loadMemPercent" class="text-xl font-bold">--%</span>
                    </div>
                    <div class="h-2 bg-dark-card rounded-full overflow-hidden">
                        <div id="loadMemBar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2" id="loadMemInfo"></div>
                </div>

                <!-- Disks -->
                <div class="bg-dark-bg rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="ri-hard-drive-2-line text-yellow-400"></i>
                        <span class="font-medium">Диски</span>
                    </div>
                    <div id="loadDisks" class="space-y-3">
                        <div class="text-gray-500 text-sm">Загрузка...</div>
                    </div>
                </div>

                <!-- Network -->
                <div class="bg-dark-bg rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="ri-wifi-line text-purple-400"></i>
                        <span class="font-medium">Сеть</span>
                    </div>
                    <div id="loadNetwork" class="space-y-4">
                        <div class="text-gray-500 text-sm">Загрузка...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Keys Modal -->
    <div id="apiKeysModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-dark-card border border-dark-border rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="px-4 sm:px-6 py-4 border-b border-dark-border flex items-center justify-between sticky top-0 bg-dark-card">
                <h3 class="font-semibold text-lg flex items-center gap-2">
                    <i class="ri-key-2-line text-yellow-400"></i>
                    API Ключи
                </h3>
                <button onclick="closeApiKeysModal()" class="p-2 hover:bg-dark-hover rounded-lg transition-colors">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-4 sm:p-6">
                <!-- Create new key -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Создать новый ключ</label>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="apiKeyDescription" placeholder="Описание (для кого)"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white placeholder-gray-600 focus:outline-none focus:border-white transition-colors">
                        <select id="apiKeyBoundIP"
                            class="w-full px-4 py-3 bg-dark-bg border border-dark-border rounded-xl text-white focus:outline-none focus:border-white transition-colors">
                            <option value="">Все IP (полный доступ)</option>
                        </select>
                        <button onclick="createApiKey()" class="w-full px-4 py-3 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                            <i class="ri-add-line"></i>
                            Создать ключ
                        </button>
                    </div>
                </div>

                <!-- New key display -->
                <div id="newKeyDisplay" class="hidden mb-6 p-4 bg-green-500/10 border border-green-500/20 rounded-xl">
                    <div class="flex items-start gap-3">
                        <i class="ri-checkbox-circle-line text-green-400 text-xl mt-0.5 flex-shrink-0"></i>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-green-400 mb-2">Ключ создан!</div>
                            <div class="flex gap-2">
                                <input type="text" id="newKeyValue" readonly
                                    class="flex-1 min-w-0 px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white font-mono text-xs">
                                <button onclick="copyNewKey()" class="px-3 py-2 bg-dark-bg border border-dark-border rounded-lg hover:bg-dark-hover transition-colors flex-shrink-0">
                                    <i class="ri-file-copy-line text-gray-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Keys table (desktop) -->
                <div class="hidden sm:block overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-dark-border">
                                <th class="text-left py-3 px-2 text-gray-400 font-medium">Ключ</th>
                                <th class="text-left py-3 px-2 text-gray-400 font-medium">Описание</th>
                                <th class="text-left py-3 px-2 text-gray-400 font-medium">Привязка к IP</th>
                                <th class="text-left py-3 px-2 text-gray-400 font-medium">Последний IP</th>
                                <th class="text-left py-3 px-2 text-gray-400 font-medium">Использование</th>
                                <th class="text-right py-3 px-2"></th>
                            </tr>
                        </thead>
                        <tbody id="apiKeysTable" class="divide-y divide-dark-border">
                            <tr><td colspan="6" class="py-8 text-center text-gray-500">Загрузка...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Keys cards (mobile) -->
                <div id="apiKeysCards" class="sm:hidden space-y-3">
                    <div class="text-center text-gray-500 py-8">Загрузка...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.pathname;
        let serverIpAddresses = []; // Хранение IP адресов сервера

        // Загрузка данных
        async function loadSystemInfo() {
            try {
                const res = await fetch(API_URL + '/api/system-info');
                const data = await res.json();
                document.getElementById('osInfo').textContent = `${data.os} ${data.version}`;
                if (data.apiDocsPath) {
                    apiDocsPath = data.apiDocsPath;
                }

                // Сохранение и отображение IP адресов
                if (data.ipAddresses && data.ipAddresses.length > 0) {
                    serverIpAddresses = data.ipAddresses;

                    // Заполняем select для выбора IP
                    const ipSelect = document.getElementById('listenIPSelect');
                    ipSelect.innerHTML = '<option value="">Все интерфейсы (0.0.0.0)</option>' +
                        data.ipAddresses.map(ip => `<option value="${ip.address}">${ip.address} (${ip.interface})</option>`).join('');

                    const ipContainer = document.getElementById('ipAddresses');
                    ipContainer.innerHTML = data.ipAddresses.map((ip, idx) => `
                        <div class="flex items-center gap-1 px-2 py-1 bg-dark-card border border-dark-border rounded-lg">
                            <span class="text-xs text-gray-300 font-mono">${ip.address}</span>
                            <button onclick="copyToClipboard('${ip.address}', this)" class="p-1 hover:bg-dark-hover rounded transition-colors" title="Копировать">
                                <i class="ri-file-copy-line text-xs text-gray-500 hover:text-white transition-all"></i>
                            </button>
                            <a href="https://check-host.net/ip-info?host=${ip.address}" target="_blank" rel="noopener noreferrer" class="p-1 hover:bg-dark-hover rounded transition-colors" title="Проверить IP">
                                <i class="ri-global-line text-xs text-gray-500 hover:text-blue-400"></i>
                            </a>
                        </div>
                    `).join('');
                }
            } catch (e) {
                document.getElementById('osInfo').textContent = 'Не определено';
            }
        }

        function copyToClipboard(text, btn) {
            // Fallback метод для всех браузеров
            const input = document.createElement('input');
            input.value = text;
            input.style.position = 'fixed';
            input.style.opacity = '0';
            document.body.appendChild(input);
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            document.body.removeChild(input);

            // Анимация успешного копирования
            if (btn) {
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'ri-check-line text-xs text-green-400 transition-all';
                btn.classList.add('scale-110');

                setTimeout(() => {
                    icon.className = originalClass;
                    btn.classList.remove('scale-110');
                }, 1500);
            }
        }

        function updateProtectionButton(isEnabled) {
            const btn = document.getElementById('protectionBtn');
            const icon = document.getElementById('protectionIcon');
            const text = document.getElementById('protectionText');

            if (isEnabled) {
                btn.disabled = true;
                btn.classList.remove('bg-dark-card', 'border-dark-border');
                btn.classList.add('bg-green-500/20', 'border-green-500/30');
                icon.classList.remove('ri-shield-line');
                icon.classList.add('ri-shield-check-line', 'text-green-400');
                text.textContent = 'Защита ON';
                text.classList.add('text-green-400');
            } else {
                btn.disabled = false;
                btn.classList.add('bg-dark-card', 'border-dark-border');
                btn.classList.remove('bg-green-500/20', 'border-green-500/30');
                icon.classList.add('ri-shield-line');
                icon.classList.remove('ri-shield-check-line', 'text-green-400');
                text.textContent = 'Защита';
                text.classList.remove('text-green-400');
            }
        }

        async function loadConfigs() {
            const container = document.getElementById('sitesContainer');
            container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500"><i class="ri-loader-4-line animate-spin text-2xl"></i></div>';

            try {
                const res = await fetch(API_URL + '/api/configs');
                const configs = await res.json();

                // Проверяем наличие default конфига и обновляем кнопку защиты
                const hasDefault = configs.some(c => c.isDefault);
                updateProtectionButton(hasDefault);

                if (configs.length === 0) {
                    container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500"><i class="ri-inbox-line text-3xl mb-2"></i><p>Нет конфигураций</p></div>';
                    return;
                }

                container.innerHTML = configs.map(config => {
                    if (config.isDefault) {
                        // Специальный стиль для default конфига
                        return `
                    <div class="px-6 py-4 flex items-center justify-between bg-orange-500/5 border-b border-orange-500/20">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-orange-500/10">
                                <i class="ri-shield-keyhole-line text-orange-400"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="font-medium truncate text-orange-400">${config.domain}</div>
                                <div class="text-sm text-gray-500 truncate">${config.filename}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditor('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Редактор конфига">
                                <i class="ri-code-line text-gray-400 hover:text-white"></i>
                            </button>
                            <button onclick="deleteConfig('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Отключить защиту">
                                <i class="ri-delete-bin-line text-gray-400 hover:text-red-400"></i>
                            </button>
                        </div>
                    </div>`;
                    }
                    // Обычный сайт
                    return `
                    <div class="px-6 py-4 flex items-center justify-between hover:bg-dark-hover transition-colors">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${config.sslStatus === 'ok' ? 'bg-green-500/10' : 'bg-red-500/10'}">
                                <i class="ri-${config.sslStatus === 'ok' ? 'shield-check' : 'shield-cross'}-line ${config.sslStatus === 'ok' ? 'text-green-400' : 'text-red-400'}"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="font-medium truncate flex items-center gap-2">
                                    ${config.domain}
                                    ${config.listenIP ? `<span class="text-xs px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded-full font-mono">${config.listenIP}</span>` : ''}
                                </div>
                                <div class="text-sm text-gray-500 truncate">${config.filename}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editConfig('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Редактировать">
                                <i class="ri-edit-line text-gray-400 hover:text-white"></i>
                            </button>
                            <button onclick="openEditor('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Редактор конфига">
                                <i class="ri-code-line text-gray-400 hover:text-white"></i>
                            </button>
                            <button onclick="showReissueModal('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Перевыпуск SSL">
                                <i class="ri-refresh-line text-gray-400 hover:text-white"></i>
                            </button>
                            <button onclick="deleteConfig('${config.filename}')" class="p-2 hover:bg-dark-bg rounded-lg transition-colors" title="Удалить">
                                <i class="ri-delete-bin-line text-gray-400 hover:text-red-400"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                container.innerHTML = '<div class="px-6 py-8 text-center text-red-400">Ошибка загрузки</div>';
            }
        }

        async function loadLogs() {
            try {
                const res = await fetch(API_URL + '/api/logs');
                const logs = await res.json();
                document.getElementById('logsContainer').textContent = logs.join('\n') || 'Логи пусты';
            } catch (e) {
                document.getElementById('logsContainer').textContent = 'Ошибка загрузки логов';
            }
        }

        // Модальные окна
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Добавить сайт';
            document.getElementById('siteForm').reset();
            document.getElementById('editFilename').value = '';
            document.getElementById('domainInput').readOnly = false;
            document.getElementById('listenIPSelect').value = '';
            document.getElementById('customSSLFields').classList.add('hidden');
            document.getElementById('siteModal').classList.remove('hidden');
            document.getElementById('siteModal').classList.add('flex');
        }

        async function editConfig(filename) {
            try {
                const res = await fetch(API_URL + '/api/config/' + encodeURIComponent(filename));
                const config = await res.json();

                document.getElementById('modalTitle').textContent = 'Редактировать сайт';
                document.getElementById('editFilename').value = filename;
                document.getElementById('domainInput').value = config.domain;
                document.getElementById('domainInput').readOnly = true;
                document.getElementById('proxyPassInput').value = config.proxyPass;
                document.getElementById('websocketInput').value = config.websocketPath || '';
                document.getElementById('listenIPSelect').value = config.listenIP || '';
                document.getElementById('sslTypeSelect').value = 'letsencrypt';
                document.getElementById('customSSLFields').classList.add('hidden');
                document.getElementById('siteModal').classList.remove('hidden');
                document.getElementById('siteModal').classList.add('flex');
            } catch (e) {
                alert('Ошибка загрузки конфигурации');
            }
        }

        function closeModal() {
            document.getElementById('siteModal').classList.add('hidden');
            document.getElementById('siteModal').classList.remove('flex');
        }

        function toggleSSLFields() {
            const type = document.getElementById('sslTypeSelect').value;
            const fields = document.getElementById('customSSLFields');
            fields.classList.toggle('hidden', type !== 'custom');
        }

        // Reissue Modal
        function showReissueModal(filename) {
            document.getElementById('reissueFilename').value = filename;
            document.getElementById('reissueSslType').value = 'letsencrypt';
            document.getElementById('reissueCustomSSLFields').classList.add('hidden');
            document.getElementById('reissueSslCert').value = '';
            document.getElementById('reissueSslKey').value = '';
            document.getElementById('reissueModal').classList.remove('hidden');
            document.getElementById('reissueModal').classList.add('flex');
        }

        function closeReissueModal() {
            document.getElementById('reissueModal').classList.add('hidden');
            document.getElementById('reissueModal').classList.remove('flex');
        }

        function toggleReissueSSLFields() {
            const type = document.getElementById('reissueSslType').value;
            document.getElementById('reissueCustomSSLFields').classList.toggle('hidden', type !== 'custom');
        }

        // Действия
        document.getElementById('siteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalContent = submitBtn.innerHTML;

            // Включаем лоадинг
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Сохранение...';

            const formData = new FormData(e.target);
            const filename = formData.get('filename');
            const isEdit = !!filename;

            const data = {
                domain: formData.get('domain'),
                proxyPass: formData.get('proxyPass'),
                websocketPath: formData.get('websocketPath') || '',
                listenIP: formData.get('listenIP') || '',
                sslType: formData.get('sslType'),
                sslCert: formData.get('sslCert') || '',
                sslKey: formData.get('sslKey') || ''
            };

            try {
                const url = isEdit ? API_URL + '/api/config/' + encodeURIComponent(filename) : API_URL + '/api/configs';
                const method = isEdit ? 'PUT' : 'POST';

                if (isEdit) {
                    data.updateSSL = data.sslType !== 'letsencrypt' || data.sslCert || data.sslKey;
                }

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (res.ok) {
                    closeModal();
                    loadConfigs();
                    loadLogs();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка сохранения');
            } finally {
                // Выключаем лоадинг
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalContent;
            }
        });

        document.getElementById('reissueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const filename = document.getElementById('reissueFilename').value;
            const sslType = document.getElementById('reissueSslType').value;
            const sslCert = document.getElementById('reissueSslCert').value;
            const sslKey = document.getElementById('reissueSslKey').value;

            if (sslType === 'custom' && (!sslCert || !sslKey)) {
                alert('Укажите сертификат и ключ');
                return;
            }

            try {
                const res = await fetch(API_URL + '/api/reissue-cert/' + encodeURIComponent(filename), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sslType, sslCert, sslKey })
                });

                const result = await res.json();

                if (res.ok) {
                    closeReissueModal();
                    loadConfigs();
                    loadLogs();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка перевыпуска');
            }
        });

        async function deleteConfig(filename) {
            if (!confirm('Удалить конфигурацию ' + filename + '?')) return;

            try {
                const res = await fetch(API_URL + '/api/configs/' + encodeURIComponent(filename), { method: 'DELETE' });
                if (res.ok) {
                    loadConfigs();
                    loadLogs();
                } else {
                    const result = await res.json();
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка удаления');
            }
        }

        async function setupDefault() {
            if (!confirm('Создать защитную конфигурацию по умолчанию?\n\nВсе неизвестные домены будут заблокированы.')) return;

            try {
                const res = await fetch(API_URL + '/api/setup-default', { method: 'POST' });
                if (res.ok) {
                    alert('Защита активирована');
                    loadConfigs();
                    loadLogs();
                } else {
                    const result = await res.json();
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка');
            }
        }

        function openEditor(filename) {
            window.location.href = API_URL + '/editor?file=' + encodeURIComponent(filename);
        }

        let apiDocsPath = '/api-docs'; // Default value, will be overridden from backend

        function openDocs() {
            window.open(apiDocsPath, '_blank');
        }

        // System Load
        let loadInterval = null;
        let networkGraphData = {}; // { iface: { download: [], upload: [] } }
        const MAX_GRAPH_POINTS = 60;

        function showLoadModal() {
            document.getElementById('loadModal').classList.remove('hidden');
            document.getElementById('loadModal').classList.add('flex');
            // Сброс данных графика при открытии
            networkGraphData = {};
            loadSystemLoad();
            loadInterval = setInterval(loadSystemLoad, 2000);
        }

        function closeLoadModal() {
            document.getElementById('loadModal').classList.add('hidden');
            document.getElementById('loadModal').classList.remove('flex');
            if (loadInterval) {
                clearInterval(loadInterval);
                loadInterval = null;
            }
            // Очистка данных графика при закрытии
            networkGraphData = {};
        }

        function drawNetworkGraph(canvasId, ifaceName) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const data = networkGraphData[ifaceName];
            if (!data) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();

            // Устанавливаем размер canvas
            canvas.width = rect.width;
            canvas.height = rect.height;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 5;

            // Очистка
            ctx.clearRect(0, 0, width, height);

            if (data.download.length === 0) return;

            // Находим максимальное значение для масштабирования
            const allValues = [...data.download, ...data.upload];
            const maxValue = Math.max(...allValues, 1024); // минимум 1KB/s для масштаба

            // Обновляем отображение максимума
            const maxEl = document.getElementById('networkGraphMax_' + ifaceName);
            if (maxEl) maxEl.textContent = formatSpeedValue(maxValue);

            const pointWidth = (width - padding * 2) / (MAX_GRAPH_POINTS - 1);

            // Рисуем сетку
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                const y = padding + (height - padding * 2) * (i / 3);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            // Функция для рисования линии
            function drawLine(lineData, color, fillColor) {
                if (lineData.length < 2) return;

                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';

                const startIdx = Math.max(0, MAX_GRAPH_POINTS - lineData.length);

                for (let i = 0; i < lineData.length; i++) {
                    const x = padding + (startIdx + i) * pointWidth;
                    const y = height - padding - (lineData[i] / maxValue) * (height - padding * 2);

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Заливка под графиком
                ctx.lineTo(padding + (startIdx + lineData.length - 1) * pointWidth, height - padding);
                ctx.lineTo(padding + startIdx * pointWidth, height - padding);
                ctx.closePath();
                ctx.fillStyle = fillColor;
                ctx.fill();
            }

            // Рисуем Download (зеленый)
            drawLine(data.download, 'rgba(74, 222, 128, 1)', 'rgba(74, 222, 128, 0.15)');

            // Рисуем Upload (синий)
            drawLine(data.upload, 'rgba(96, 165, 250, 1)', 'rgba(96, 165, 250, 0.15)');
        }

        function formatSpeedValue(bytesPerSec) {
            if (bytesPerSec <= 0) return '0 B/s';
            const k = 1024;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            const i = Math.floor(Math.log(bytesPerSec) / Math.log(k));
            return parseFloat((bytesPerSec / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function parseSpeedToBytes(speedStr) {
            if (!speedStr) return 0;
            const match = speedStr.match(/([\d.]+)\s*(B|KB|MB|GB)\/s/);
            if (!match) return 0;
            const value = parseFloat(match[1]);
            const unit = match[2];
            const multipliers = { 'B': 1, 'KB': 1024, 'MB': 1024 * 1024, 'GB': 1024 * 1024 * 1024 };
            return value * (multipliers[unit] || 1);
        }

        async function loadSystemLoad() {
            try {
                const res = await fetch(API_URL + '/api/system-load');
                const data = await res.json();

                // CPU
                document.getElementById('loadCpuPercent').textContent = data.cpu.usage + '%';
                document.getElementById('loadCpuModel').textContent = data.cpu.model;
                document.getElementById('loadCpuBar').style.width = data.cpu.usage + '%';
                document.getElementById('loadCpuBar').className = `h-full transition-all duration-300 ${data.cpu.usage > 80 ? 'bg-red-500' : data.cpu.usage > 50 ? 'bg-yellow-500' : 'bg-blue-500'}`;
                document.getElementById('loadCpuInfo').textContent = `${data.cpu.cores} ядер | Load: ${data.cpu.loadAvg.join(', ')}`;

                // Memory
                document.getElementById('loadMemPercent').textContent = data.memory.percent + '%';
                document.getElementById('loadMemBar').style.width = data.memory.percent + '%';
                document.getElementById('loadMemBar').className = `h-full transition-all duration-300 ${data.memory.percent > 80 ? 'bg-red-500' : data.memory.percent > 50 ? 'bg-yellow-500' : 'bg-green-500'}`;
                document.getElementById('loadMemInfo').textContent = `${data.memory.used} / ${data.memory.total}`;

                // Disks
                if (data.disk && data.disk.length > 0) {
                    document.getElementById('loadDisks').innerHTML = data.disk.map(d => `
                        <div>
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span class="text-gray-400">${d.mount}</span>
                                <span class="text-gray-300">${d.percent}%</span>
                            </div>
                            <div class="h-2 bg-dark-card rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-300 ${d.percent > 90 ? 'bg-red-500' : d.percent > 70 ? 'bg-yellow-500' : 'bg-yellow-400'}" style="width: ${d.percent}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${d.used} / ${d.size} (свободно ${d.available})</div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('loadDisks').innerHTML = '<div class="text-gray-500 text-sm">Нет данных</div>';
                }

                // Network
                if (data.network && data.network.length > 0) {
                    // Обновляем данные графиков для каждого интерфейса
                    data.network.forEach(n => {
                        if (!networkGraphData[n.interface]) {
                            networkGraphData[n.interface] = { download: [], upload: [] };
                        }

                        const download = parseSpeedToBytes(n.rxSpeed);
                        const upload = parseSpeedToBytes(n.txSpeed);

                        networkGraphData[n.interface].download.push(download);
                        networkGraphData[n.interface].upload.push(upload);

                        // Ограничиваем количество точек
                        if (networkGraphData[n.interface].download.length > MAX_GRAPH_POINTS) {
                            networkGraphData[n.interface].download.shift();
                            networkGraphData[n.interface].upload.shift();
                        }
                    });

                    // Генерируем HTML для каждого интерфейса с отдельным графиком
                    document.getElementById('loadNetwork').innerHTML = data.network.map(n => `
                        <div class="bg-dark-card rounded-lg p-3 border border-dark-border">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-200 font-medium">${n.interface}</span>
                                    ${n.ipv4 ? `<span class="text-xs px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded-full font-mono">${n.ipv4}</span>` : ''}
                                </div>
                                <span id="networkGraphMax_${n.interface}" class="text-xs text-gray-500">0 KB/s</span>
                            </div>
                            <div class="relative h-20 bg-dark-bg rounded-lg overflow-hidden border border-dark-border mb-2">
                                <canvas id="networkGraph_${n.interface}" class="w-full h-full"></canvas>
                                <div class="absolute bottom-1 right-2 flex items-center gap-3 text-xs">
                                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full"></span> Down</span>
                                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-blue-400 rounded-full"></span> Up</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-4">
                                    <div class="flex items-center gap-1.5">
                                        <i class="ri-arrow-down-line text-green-400 text-sm"></i>
                                        <span class="text-green-400 font-mono text-sm">${n.rxSpeed}</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <i class="ri-arrow-up-line text-blue-400 text-sm"></i>
                                        <span class="text-blue-400 font-mono text-sm">${n.txSpeed}</span>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500">Всего: ${n.rx} / ${n.tx}</span>
                            </div>
                        </div>
                    `).join('');

                    // Перерисовываем графики для каждого интерфейса
                    data.network.forEach(n => {
                        drawNetworkGraph('networkGraph_' + n.interface, n.interface);
                    });
                } else {
                    document.getElementById('loadNetwork').innerHTML = '<div class="text-gray-500 text-sm">Нет данных</div>';
                }

                // Uptime
                document.getElementById('loadUptime').textContent = `Uptime: ${data.uptime}`;

            } catch (e) {
                console.error('Error loading system load:', e);
            }
        }

        // API Keys
        function showApiKeysModal() {
            document.getElementById('apiKeysModal').classList.remove('hidden');
            document.getElementById('apiKeysModal').classList.add('flex');
            document.getElementById('newKeyDisplay').classList.add('hidden');

            // Заполняем select IP адресами
            const ipSelect = document.getElementById('apiKeyBoundIP');
            ipSelect.innerHTML = '<option value="">Все IP (полный доступ)</option>' +
                serverIpAddresses.map(ip => `<option value="${ip.address}">${ip.address} (${ip.interface})</option>`).join('');

            loadApiKeys();
        }

        function closeApiKeysModal() {
            document.getElementById('apiKeysModal').classList.add('hidden');
            document.getElementById('apiKeysModal').classList.remove('flex');
        }

        async function loadApiKeys() {
            const table = document.getElementById('apiKeysTable');
            const cards = document.getElementById('apiKeysCards');
            table.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500"><i class="ri-loader-4-line animate-spin"></i></td></tr>';
            cards.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="ri-loader-4-line animate-spin"></i></div>';

            try {
                const res = await fetch(API_URL + '/api/api-keys');
                const keys = await res.json();

                if (keys.length === 0) {
                    table.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-500">Нет API ключей</td></tr>';
                    cards.innerHTML = '<div class="text-center text-gray-500 py-8">Нет API ключей</div>';
                    return;
                }

                // Desktop table
                table.innerHTML = keys.map(key => `
                    <tr class="hover:bg-dark-hover">
                        <td class="py-3 px-2">
                            <div class="flex items-center gap-1">
                                <code class="text-xs text-gray-400 font-mono">${key.key}</code>
                                <button onclick="copyApiKey('${key.fullKey}', this)" class="p-1 hover:bg-dark-bg rounded transition-colors" title="Копировать">
                                    <i class="ri-file-copy-line text-xs text-gray-500 hover:text-white"></i>
                                </button>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-gray-300">${key.description}</td>
                        <td class="py-3 px-2">
                            ${key.boundIP
                                ? `<span class="text-xs px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded-full font-mono">${key.boundIP}</span>`
                                : '<span class="text-xs text-gray-500">Все</span>'}
                        </td>
                        <td class="py-3 px-2 text-gray-500 text-xs">${key.lastIp || '-'}</td>
                        <td class="py-3 px-2 text-gray-500 text-xs">${key.lastUsedAt ? new Date(key.lastUsedAt).toLocaleString('ru') : 'Никогда'}</td>
                        <td class="py-3 px-2 text-right">
                            <button onclick="deleteApiKey('${key.fullKey}')" class="p-1.5 hover:bg-dark-bg rounded-lg transition-colors" title="Удалить">
                                <i class="ri-delete-bin-line text-gray-400 hover:text-red-400"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Mobile cards
                cards.innerHTML = keys.map(key => `
                    <div class="bg-dark-bg border border-dark-border rounded-xl p-4">
                        <div class="flex items-start justify-between gap-2 mb-3">
                            <div class="font-medium text-white text-sm">${key.description}</div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <button onclick="copyApiKey('${key.fullKey}', this)" class="p-1.5 hover:bg-dark-hover rounded-lg transition-colors" title="Копировать ключ">
                                    <i class="ri-file-copy-line text-gray-400 hover:text-white"></i>
                                </button>
                                <button onclick="deleteApiKey('${key.fullKey}')" class="p-1.5 hover:bg-dark-hover rounded-lg transition-colors" title="Удалить">
                                    <i class="ri-delete-bin-line text-gray-400 hover:text-red-400"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Ключ:</span>
                                <code class="text-gray-400 font-mono">${key.key}</code>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Привязка к IP:</span>
                                ${key.boundIP
                                    ? `<span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded-full font-mono">${key.boundIP}</span>`
                                    : '<span class="text-gray-400">Все</span>'}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Последний IP:</span>
                                <span class="text-gray-400">${key.lastIp || '-'}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-500">Использование:</span>
                                <span class="text-gray-400">${key.lastUsedAt ? new Date(key.lastUsedAt).toLocaleString('ru') : 'Никогда'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                table.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-red-400">Ошибка загрузки</td></tr>';
                cards.innerHTML = '<div class="text-center text-red-400 py-8">Ошибка загрузки</div>';
            }
        }

        function copyApiKey(key, btn) {
            copyToClipboard(key, btn);
        }

        async function createApiKey() {
            const description = document.getElementById('apiKeyDescription').value.trim();
            const boundIP = document.getElementById('apiKeyBoundIP').value;

            if (!description) {
                alert('Введите описание ключа');
                return;
            }

            try {
                const res = await fetch(API_URL + '/api/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, boundIP })
                });

                const result = await res.json();

                if (res.ok) {
                    document.getElementById('apiKeyDescription').value = '';
                    document.getElementById('newKeyValue').value = result.apiKey;
                    document.getElementById('newKeyDisplay').classList.remove('hidden');
                    loadApiKeys();
                    loadLogs();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка создания ключа');
            }
        }

        async function deleteApiKey(key) {
            if (!confirm('Удалить этот API ключ?')) return;

            try {
                const res = await fetch(API_URL + '/api/api-keys/' + encodeURIComponent(key), { method: 'DELETE' });
                if (res.ok) {
                    loadApiKeys();
                    loadLogs();
                } else {
                    const result = await res.json();
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (e) {
                alert('Ошибка удаления');
            }
        }

        function copyNewKey() {
            const input = document.getElementById('newKeyValue');
            input.select();
            document.execCommand('copy');
            alert('Ключ скопирован!');
        }

        async function logout() {
            await fetch(API_URL + '/api/logout', { method: 'POST' });
            window.location.href = API_URL + '/login';
        }

        // Закрытие модалок по клику вне (кроме siteModal - только на крестик)
        // siteModal закрывается только по крестику или кнопке "Отмена"
        document.getElementById('reissueModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeReissueModal();
        });
        document.getElementById('loadModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeLoadModal();
        });
        document.getElementById('apiKeysModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeApiKeysModal();
        });

        // Инициализация
        loadSystemInfo();
        loadConfigs();
        loadLogs();
        setInterval(loadLogs, 5000);
    </script>
</body>
</html>
